{% extends "layout.twig" %}

{% block pre_include %}
    <title>Kết quả tìm kiếm
        {{search.terms}}</title>
{% endblock %}

{% block post_include %}
    <script src="{{shop.static}}/libs/twbsPagination.min.js"></script>
    <script type="text/javascript">
        var page_number,
            total;
        page_number = jQuery(document).find('.pagination').data('page_number');
        total = jQuery(document).find('.pagination').data('total');

        if (total && parseInt(total) > 1) {
            jQuery(document).find('.pagination').twbsPagination('destroy');
            jQuery(document).find('.pagination').twbsPagination({
                totalPages: parseInt(total),
                visiblePages: 7,
                startPage: parseInt(page_number),
                initiateStartPageClick: false,
                paginationClass: 'reset-list paginationk-list',
                pageClass: 'item',
                first: false,
                prev: '<span></span>',
                prevClass: 'item',
                next: '<span></span>',
                nextClass: 'item',
                activeClass: 'active',
                disabledClass: 'disabled',
                anchorClass: 'link',
                last: false,
                href: false,
                onPageClick: function (event, page) {
                    var href = location.href;
                    var s = location.search;
                    if (!s || !s.indexOf('?page=')) {
                        if (page == 1) 
                            href = location.pathname;
                        else 
                            href = location.pathname + '?page=' + page;
                        }
                    else {
                        if (href.indexOf('&page=') > -1) 
                            href = href.substring(0, href.indexOf('&page='));
                        if (page > 1) 
                            href = href + '&page=' + page;
                        }
                    location.href = href;
                }
            });
        }
    </script>

    <script>
        var root_html = $('#filter-content').html();
        var check_price_filter = 0;
        $('.sorting1 , .soluong1').change(function (event) {
            event.preventDefault();
            var item = $('select.soluong1').val();
            var sort = $('select.sorting1').val();
            var current_url = window.location.href;
            if (current_url.indexOf('?') >= 0) {
                var conjunction = '&';
            } else {
                var conjunction = '?';
            }
            var url_array = current_url.split('perpage');
            var url = url_array[0];
            if (current_url.indexOf('perpage') >= 0) {
                conjunction = '';
            }
            if (sort) {
                url = url + conjunction + 'perpage=' + item + '&sortby=' + sort;
            } else {
                url = url + conjunction + 'perpage=' + item;
            }
            location.href = url;
        });

        $(document).on('click', '.checkbox-input', function (event) {
            loadFilter();
        });
        $(document).on('change', 'input.price-filter', function (event) {
            check_price_filter = 1;
            loadFilter();
        });
        $(document).on('change', 'select[name="soluong1"]', function (event) {
            $('select[name="soluong1"]').val($(this).val());
            loadFilter();
        });
        $(document).on('change', 'select[name="sortBy"]', function (event) {
            $('select[name="sortBy"]').val($(this).val());
            loadFilter();
        });

        function loadFilter() {
            var max_price = $('input[name="max-price-filter"]').val();
            var min_price = $('input[name="min-price-filter"]').val();
            var sortby = '&sortby=' + $('select[name="sortBy"]').val();
            var perpage = '&perpage=' + $('select[name="soluong1"]').val();
            console.log(perpage);
            console.log(sortby);
            var filter = '&filter=' + 'price>=' + min_price + '%26%26price<=' + max_price;
            var attributes_url = loadfilterUrl()
            if (!attributes_url && !check_price_filter) {
                $('#filter-content').html(root_html);
                return;
            }
            var url = '/api/search?type=product&view=snippet%2Fcollection_filter&attr=' + attributes_url + filter + perpage + sortby;
            // return;
            ajaxLoadFilter(url);
        }

        function loadfilterUrl() {
            var url = ''
            var count = 0;
            $('.filter-left-aside .filter-attributes .reset-list').each(function (val) {
                var option = $(this).data('option');
                var option_array_value = []
                var value_attribute = $(this).find('li input:checked').each(function (data) {
                    option_array_value.push($(this).data('value'));
                })
                if (option_array_value.length > 0) {
                    if (count) {
                        url += '&&' + option + 'IN' + JSON.stringify(option_array_value);
                    } else {
                        url += option + 'IN' + JSON.stringify(option_array_value);
                    }
                    count++;
                }
            })
            return encodeURIComponent(url);
        }

        function ajaxLoadFilter(url) {
            $.ajax({
                url: url,
                type: 'GET',
                success: function (html) {
                    $('#filter-content').html(html);
                    initPaginate(url);
                }
            })
        }

        function initPaginate(url) {
            var page_number,
                total;
            page_number = jQuery(document).find('.pagination').data('page_number');
            total = jQuery(document).find('.pagination').data('total');

            if (total && parseInt(total) > 1) {
                jQuery(document).find('.pagination').twbsPagination({
                    totalPages: parseInt(total),
                    visiblePages: 4,
                    startPage: parseInt(page_number),
                    initiateStartPageClick: false,
                    lastClass: false,
                    firstClass: false,
                    last: false,
                    first: false,
                    prev: '<i class="fa fa-angle-double-left" aria-hidden="true"></i>',
                    next: '<i class="fa fa-angle-double-right" aria-hidden="true"></i>',
                    href: false,
                    onPageClick: function (event, page) {
                        var href = url;
                        var s = location.search;
                        if (!s || !s.indexOf('&page=')) {
                            if (page == 1) 
                                href = url;
                            else 
                                href = url + '&page=' + page;
                            }
                        else {
                            if (href.indexOf('&page=') > -1) 
                                href = href.substring(0, href.indexOf('&page='));
                            if (page > 1) 
                                href = href + '&page=' + page;
                            }
                        $.get(href, function (html) {
                            $('#filter-content').html(html);
                            initPaginate(url);
                        })
                    }
                });
            }
        }
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            var arrar_collection_handle = [];
            $('.collection-list .reset-list .item span').each(function (val) {
                arrar_collection_handle.push($(this).attr('data-handle'));
            })
            $.ajax({
                type: 'post',
                url: 'http://localhost:4200/api/count-collection',
                data: {
                    collection_handles: arrar_collection_handle
                },
                success: function (json) {
                    if (!json.code) {
                        $.each(json.array_count, function (index, val) {
                            $('.collection-list .reset-list .item').find("[data-handle='" + val.handle + "']").html('(' + val.count + ')');
                        })
                    }
                }
            })
        })
    </script>

{% endblock post_include %}

{% block content %}

{% endblock content %}