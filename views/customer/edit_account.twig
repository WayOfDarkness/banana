{% extends "layout.twig" %}

{% block pre_include %}
    <title>Thông tin tài khoản</title>
{% endblock %}

{% block content %}

    {% set name_string = customer.name | split('/') %}

    <main class="main-content">
        <nav class="breadcrumbk">
            <div class="container">
                <ul class="reset-list breadcrumbk-list">
                    <li class="item">
                        <a href="/" class="link">
                            <i class="fa fa-home"></i>
                        </a>
                    </li>
                    <li class="item">
                        <a href="{{__('CUSTOMER_EDIT_ACCOUNT_URL')}}" class="link">Tài khoản</a>
                    </li>
                    <li class="item active">Thông tin tài khoản</li>
                </ul>
            </div>
        </nav>

        <div class="dashboard mb-35">
            <div class="container dashboard-wrap">
                <aside class="dashboard-aside js-dbAside">
                    <button class="reset-btn dashboard-aside--close f-b d-lg-none">
                        <i class="fa fa-angle-left"></i>Trở về</button>

                    <div class="dashboard-aside--inner js-blurOff">
                        <h4 class="title-1 text-uppercase fs_24 cl_blue">tài khoản</h4>

                        <ul class="reset-list dashboard-aside__list">
                            <li class="item active">
                                <a href="{{__('CUSTOMER_EDIT_ACCOUNT_URL')}}" class="d-block fl">Thông tin tài khoản</a>
                            </li>
                            <li class="item">
                                <a href="/customer/addressBook?view=customer/address" class="d-block fl">Sổ địa chỉ</a>
                            </li>
                            <li class="item">
                                <a href="{{__('SAVE_POINT_URL')}}" class="d-block fl">Điểm tích luỹ</a>
                            </li>
                            <li class="item">
                                <a href="{{__('CUSTOMER_ORDERS_URL')}}" class="d-block fl">Lịch sử đơn hàng</a>
                            </li>
                            <li class="item">
                                <a href="{{__('CUSTOMER_WISHLIST_URL')}}" class="d-block fl">Yêu thích</a>
                            </li>
                            <li class="item">
                                <a href="/customer/subscribe?view=customer/subcribe" class="d-block fl">Đăng ký nhận tin điện tử</a>
                            </li>
                            <li class="item">
                                <a href="{{__('REFERRAL_URL')}}" class="d-block fl">Mã giới thiệu</a>
                            </li>
                        </ul>
                    </div>
                </aside>

                <div class="dashboard-content">
                    <btn class="mb-15 reset-btn dashboard-aside--open js-dbAsideTrigger fb fs_15 d-block d-lg-none">
                        <i class="fa fa-hand-point-right cl_blue mr-1"></i>Bảng thông tin</btn>

                    <div class="dashboard-content__detail pb-2 h-unset payment-page">
                        <h4 class="title-1 text-uppercase fs_24 cl_blue mb-4">CHỈNH SỬA THÔNG TIN TÀI KHOẢN</h4>

                        <div class="text fl lh-24 d-flex flex-wrap dang-ky loginModal">
                            <div class="col-12 px-0 pb-1">
                                <form id="customer-change-info" class="login-form px-50 mb-3">
                                    <div class="form-row">
                                        <div class="form-group col-12 col-md-6 mb-10">
                                            <input type="text" id="customer-firstname" class="form-control style2 mb-0" placeholder="Tên*" value="{{name_string[1]}}"/>
                                        </div>
                                        <div class="form-group col-12 col-md-6 mb-10 d-flex align-items-center style2">
                                            <label class="form-label mb-0">Ngày sinh</label>
                                            <div class="d-flex form-control-wrap border-bottom-0 p-0 mr--10">
                                                <div class="col-4">
                                                    <input type="text" id="customer-date" class="form-control style2 mb-0" placeholder="30" value="{{customer.birthday | split('-')[2]}}"/>
                                                </div>
                                                <div class="col-4">
                                                    <input type="text" id="customer-month" class="form-control style2 mb-0" placeholder="10" value="{{customer.birthday | split('-')[1]}}"/>
                                                </div>
                                                <div class="col-4">
                                                    <input type="text" id="customer-year" class="form-control style2 mb-0" placeholder="1997" value="{{customer.birthday | split('-')[0]}}"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-12 col-md-6 mb-10">
                                            <input type="text" id="customer-lastname" class="form-control style2 mb-0" placeholder="Họ*" value="{{name_string[0]}}"/>
                                        </div>

                                        <div class="form-group col-12 col-md-6 mb-10">
                                            <div class="filter-wrap mb-0">
                                                <label class="form-label pr-33 mb-0">Giới tính</label>
                                                <div class="selectbox">
                                                    <select id="customer-gender">
                                                        {% if 'Khác' == customer.gender %}
                                                            <option value="Nam">Nam</option>
                                                            <option value="Nữ">Nữ</option>
                                                            <option value="Khác" selected="selected">Khác</option>
                                                        {% elseif 'Nữ' == customer.gender %}
                                                            <option value="Nam">Nam</option>
                                                            <option value="Nữ" selected="selected">Nữ</option>
                                                            <option value="Khác">Khác</option>
                                                        {% else %}
                                                            <option value="Nam" selected="selected">Nam</option>
                                                            <option value="Nữ">Nữ</option>
                                                            <option value="Khác">Khác</option>
                                                        {% endif %}
                                                    </select>
                                                    <i class="fa fa-caret-down"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <span class="d-block fl" id="customer-email">{{customer.email}}</span>

                                    <div class="form-row">
                                        <div class="form-group col-12 col-md-6 mb-1 mt-4">
                                            <label class="checkbox style2 d-flex align-items-center mb-0">
                                                <input type="checkbox" id="isCheckedChangePassword" class="checkbox-input">
                                                <span class="checkbox-icon"></span>
                                                <span class="checkbox-text cl_blue">Đổi mật khẩu</span>
                                            </label>
                                        </div>
                                    </div>

                                    <span class="bt-1 d-block text-uppercase py-2 fm">Đổi mật khẩu</span>
                                    <div class="form--row">
                                        <div class="form-group col-12 col-md-6 mb-10 pl-0 pr-max-md-0">
                                            <input type="password" id="oldPass" class="form-control style2 mb-0" placeholder="Mật khẩu hiện tại*"/>
                                        </div>
                                        <div class="form-group col-12 col-md-6 mb-10 pl-0 pr-max-md-0">
                                            <input type="password" id="newPass" class="form-control style2 mb-0" placeholder="Mật khẩu mới*"/>
                                        </div>
                                        <div class="form-group col-12 col-md-6 mb-10 pl-0 pr-max-md-0">
                                            <input type="password" id="newPassConfirm" class="form-control style2 mb-0" placeholder="Nhập lại mật khẩu mới*"/>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="come-back w-100 mx-20 bt-1 fm pt-2 d-flex flex-wrap align-items-center justify-content-between pl-30">
                                <a href="javascript:history.back(-1)" class="d-block cl_blue">
                                    <i class="fa fa-angle-double-left"></i>
                                    Quay lại
                                </a>
                                <span class="cl_red fl">(*): bắt buộc</span>
                            </div>
                            <button id="button-change-info" class="ml-auto mr-3 mt-2 mw-unset	reset-btn btn-blue mb-3 px-4">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        $(function () {
            var regExp = /[0-9]/;

            $("#customer-year, #customer-month, #customer-date").on('keydown keyup', function (e) {
                var value = String.fromCharCode(e.which) || e.key;

                if (!regExp.test(value) && e.which != 8 && e.which != 9 && e.which != 46 && (e.which < 37 || e.which > 40)) {
                    e.preventDefault();
                    return false;
                }
            });
        });

        $("#button-change-info").click(function (e) {
            e.preventDefault();

            if ($("#isCheckedChangePassword").is(":checked")) {

                var newPassConfirm = $("#newPassConfirm").val();
                var data = {
                    old_password: $("#oldPass").val(),
                    new_password: $("#newPass").val()
                };

                if (!data.old_password) {
                    $('#oldPass').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập mật khẩu hiện tại");
                    return;
                } else {
                    $('#oldPass').removeClass('noti-input-error');
                }

                if (!data.new_password) {
                    $('#newPass').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập mật khẩu mới");
                    return;
                } else {
                    $('#newPass').removeClass('noti-input-error');
                }

                if (data.new_password != newPassConfirm) {
                    $('#newPassConfirm').addClass('noti-input-error');
                    toastr.error('Mật khẩu không trùng khớp');
                    return;
                } else {
                    $('#newPassConfirm').removeClass('noti-input-error');
                }

                $.ajax({
                    url: "/api/changePassword",
                    type: "POST",
                    data: data,
                    success: function (result) {
                        if (!result.code) {
                            toastr.success(result.message);
                            $('#newPassConfirm').removeClass('noti-input-error');
                            $('#newPass').removeClass('noti-input-error');
                            $('#oldPass').removeClass('noti-input-error');
                            setTimeout(function () {
                                location.href = "{{__('CUSTOMER_URL')}}";
                            }, 1000);
                        } else {
                            toastr.error(result.message);
                            $('#newPassConfirm').addClass('noti-input-error');
                            $('#newPass').addClass('noti-input-error');
                            $('#oldPass').addClass('noti-input-error');
                        }
                    }
                });
            } else {
                var date = $("#customer-date").val();
                var month = $("#customer-month").val();
                var year = $("#customer-year").val();
                var firstName = $("#customer-firstname").val();
                var lastName = $("#customer-lastname").val();

                var data = {
                    email: $("#customer-email").html(),
                    name: lastName + "/" + firstName,
                    gender: $("#customer-gender").val(),
                    birthday: year + "-" + month + "-" + date
                };

                if (!firstName) {
                    $('#customer-firstname').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập tên");
                    return;
                } else {
                    $('#customer-firstname').removeClass('noti-input-error');
                }

                if (!lastName) {
                    $('#customer-lastname').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập họ");
                    return;
                } else {
                    $('#customer-lastname').removeClass('noti-input-error');
                }

                if (month == 2 && date > 28) {
                    $('#customer-date').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập lại ngày sinh");
                    return;
                } else {
                    $('#customer-date').removeClass('noti-input-error');
                }

                if (date == 31 && month != 1 && month != 3 && month != 5 && month != 7 && month != 8 && month != 10 && month != 12) {
                    $('#customer-date').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập lại ngày sinh");
                    return;
                } else {
                    $('#customer-date').removeClass('noti-input-error');
                }

                if (date > 31) {
                    $('#customer-date').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập lại ngày sinh");
                    return;
                } else {
                    $('#customer-date').removeClass('noti-input-error');
                }

                if (month > 12) {
                    $('#customer-date').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập lại ngày sinh");
                    return;
                } else {
                    $('#customer-date').removeClass('noti-input-error');
                }

                if (year > 2018) {
                    $('#customer-year').addClass('noti-input-error');
                    toastr.error("Vui lòng nhập lại năm sinh");
                    return;
                } else {
                    $('#customer-year').removeClass('noti-input-error');
                }

                $.ajax({
                    url: "/api/changeInformation",
                    type: "POST",
                    data: data,
                    success: function (result) {
                        if (!result.code) {
                            toastr.success("Thay đổi thông tin thành công");
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        } else {
                            toastr.error(result.message);
                        }
                    }
                });
            }

        });
    </script>
{% endblock content %}